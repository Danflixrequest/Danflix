<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Danflix - Movie Request</title>
  <link rel="icon" href="Logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body.blurred #pageContent {
      filter: blur(8px);
      pointer-events: none;
      user-select: none;
    }
    #authOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      backdrop-filter: blur(10px);
      background-color: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .auth-box {
      background: white;
      padding: 2rem 2.5rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      min-width: 320px;
      max-width: 350px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .auth-box input {
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 0.6rem;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .auth-box img {
      width: 220px;
      height: auto;
      margin-bottom: 1rem;
    }
    .auth-box button {
      margin-top: 0.2rem;
      padding: 10px 20px;
      background-color: #e50914;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .auth-box button:hover {
      background-color: #bf0810;
    }
    .auth-switch {
      margin: 1rem 0 0.5rem 0;
      font-size: 0.95rem;
      color: #333;
      cursor: pointer;
      text-decoration: underline;
    }
    .auth-box p {
      margin: 0.5rem 0 0 0;
      color: red;
      display: none;
    }
    #userWelcome {
      margin-bottom: 2rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 1rem;
      width: 100%;
      max-width: 250px;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    #logo {
      width: 350px;
      height: auto;
      margin-bottom: 1.5rem;
      display: block;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      z-index: 1;
    }
    input#searchInput {
      display: block;
      margin-left: auto;
      margin-right: auto;
      padding: 16px;
      font-size: 1.2rem;
      width: 96vw;
      max-width: 350px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 1vw;
      position: relative;
      z-index: 1;
    }
    .movie {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      gap: 1rem;
      width: 100%;
      max-width: 350px;
      margin-top: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }
    img:not(.auth-logo) {
      width: 100px;
      height: auto;
      border-radius: 4px;
    }
    button, .danflix-button {
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #e50914;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      text-transform: none;
      text-align: center;
      display: inline-block;
      text-decoration: none;
    }
    button:hover, .danflix-button:hover {
      background-color: #bf0810;
      color: white;
      transform: scale(1.05);
    }
    button:disabled, .danflix-button:disabled {
      background-color: #cccccc;
      color: #666666;
      cursor: not-allowed;
      border: none;
      transform: none;
    }
    .danflix-button {
      background-color: black;
      color: #e50914;
      border: 2px solid #e50914;
      font-size: 1rem;
      text-transform: none;
      margin-top: 10px;
      box-sizing: border-box;
      padding: 10px 20px;
    }
    .section-title {
      font-size: 1.5rem;
      margin-top: 2rem;
      text-align: center;
      font-weight: bold;
      position: relative;
      z-index: 1;
    }
    .highlight {
      background-color: yellow;
    }
    .admin-link {
      margin-top: 2rem;
      font-size: 0.9rem;
      position: relative;
      z-index: 1;
    }
    @media (max-width: 600px) {
      .auth-box img {
        width: 100px;
      }
      #logo {
        width: 95vw;
      }
      button, .danflix-button {
        font-size: 0.95rem;
        padding: 10px 12px;
      }
    }
    .ratings {
      font-size: 0.97rem;
      color: #444;
      margin: 0.4em 0 0.4em 0;
      display: flex;
      gap: 1.2em;
      align-items: center;
    }
    .ratings .score {
      font-weight: bold;
      color: #e50914;
      margin-right: 6px;
      display: flex;
      align-items: center;
      gap: 0.2em;
    }
    .ratings img {
      vertical-align: middle;
      width: 20px;
      height: 20px;
      margin-right: 3px;
      border-radius: 0;
      box-shadow: none;
      background: none;
    }
  </style>
</head>
<body class="blurred">
  <!-- bgOverlay removed -->
  <!-- AUTH OVERLAY -->
  <div id="authOverlay">
    <div class="auth-box">
      <img src="Danflix.png" alt="Danflix Logo" class="auth-logo"/>
      <div id="authForms">
        <div id="loginForm">
          <h2>Login</h2>
          <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" />
          <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" />
          <button onclick="login()">Log In</button>
          <p id="loginError"></p>
          <div class="auth-switch" onclick="showSignup()">No account? Sign Up</div>
        </div>
        <div id="signupForm" style="display:none;">
          <h2>Sign Up</h2>
          <input type="email" id="signupEmail" placeholder="Email" autocomplete="username" />
          <input type="password" id="signupPassword" placeholder="Password" autocomplete="new-password" />
          <button onclick="signup()">Sign Up</button>
          <p id="signupError"></p>
          <div class="auth-switch" onclick="showLogin()">Have an account? Log In</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Welcome + Main Content -->
  <div id="userWelcome" style="display:none;">
    <span id="userEmail"></span>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="pageContent">
    <img id="logo" src="Danflix.png" alt="Danflix Logo" />
    <input id="searchInput" placeholder="Search for a movie title..." oninput="searchMovies()" />
    <div class="section-title">Movie Suggestions</div>
    <div id="randomMovies"></div>
    <div id="results"></div>
    <div class="admin-link">
      <a href="requests.html">Go to Admin (Requests)</a>
    </div>
  </div>

<script>
  // Supabase setup
  const SUPABASE_URL = 'https://vthwucdhiuewqfljbafu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0aHd1Y2RoaXVld3FmbGpiYWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDY3NjYsImV4cCI6MjA3MTE4Mjc2Nn0.JaLXafZhYMYQwjuZErwrGph080jWYqOXhkpjRRP9gg0';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // TMDb API
  const TMDB_API_KEY = '9b9dd1ae2eafae23ed2c2c675d2b4407';

  // Ratings Icons
  const IMDB_ICON = 'https://upload.wikimedia.org/wikipedia/commons/6/69/IMDB_Logo_2016.svg';
  const RT_ICON = 'https://upload.wikimedia.org/wikipedia/commons/5/5b/Rotten_Tomatoes.svg';

  let plexTitles = [];
  let plexReady = false;

  // Auth overlay UI switching
  function showSignup() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = '';
  }
  function showLogin() {
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('loginForm').style.display = '';
  }

  // AUTH section logic
  async function signup() {
    document.getElementById('signupError').style.display = "none";
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) {
      document.getElementById('signupError').innerText = error.message;
      document.getElementById('signupError').style.display = "block";
    } else {
      alert('Check your email for a confirmation link!');
      showLogin();
    }
  }

  async function login() {
    document.getElementById('loginError').style.display = "none";
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      document.getElementById('loginError').innerText = error.message;
      document.getElementById('loginError').style.display = "block";
    } else {
      document.getElementById('loginError').style.display = "none";
      showUser(data.user);
      hideAuthOverlay();
    }
  }

  function showUser(user) {
    if (!user) return;
    document.getElementById('userWelcome').style.display = 'block';
    document.getElementById('userEmail').innerText = `Welcome, ${user.email}`;
  }

  function hideUser() {
    document.getElementById('userWelcome').style.display = 'none';
    document.getElementById('userEmail').innerText = '';
  }

  async function logout() {
    await supabase.auth.signOut();
    hideUser();
    showAuthOverlay();
  }

  async function getCurrentUser() {
    const { data } = await supabase.auth.getUser();
    return data?.user || null;
  }

  function showAuthOverlay() {
    document.getElementById('authOverlay').style.display = 'flex';
    document.body.classList.add('blurred');
    hideUser();
  }
  function hideAuthOverlay() {
    document.getElementById('authOverlay').style.display = 'none';
    document.body.classList.remove('blurred');
  }

  // Highlight search matches
  function highlightMatch(title) {
    const searchTerm = document.getElementById("searchInput").value.trim();
    if (!searchTerm) return title;
    const regex = new RegExp(`(${searchTerm})`, "gi");
    return title.replace(regex, `<span class="highlight">$1</span>`);
  }

  // Fetch plex_titles.json instead of Plex server directly
  async function fetchPlexTitles() {
    try {
      const res = await fetch("plex_titles.json");
      plexTitles = await res.json();
      plexReady = true;
    } catch (err) {
      plexReady = true;
      alert("Could not load Plex titles list. 'On Danflix' status may not be accurate.");
    }
  }

  function normalizeTitle(title) {
    return title.replace(/\s*[\(\[\{].*?[\)\]\}]\s*/g, '').trim().toLowerCase();
  }
  function isOnPlex(title) {
    if (!plexReady) return false;
    const normTitle = normalizeTitle(title);
    return plexTitles.some(plexTitle => normalizeTitle(plexTitle) === normTitle);
  }

  // TMDb helpers
  function getPosterUrl(path) {
    return path ? `https://image.tmdb.org/t/p/w300${path}` : 'https://placehold.co/100x150?text=No+Image';
  }
  function getYear(date) {
    return date ? date.split('-')[0] : '';
  }

  // Random movie suggestions from TMDb
  async function fetchRandomMovies() {
    const container = document.getElementById("randomMovies");
    if (!plexReady) {
      container.innerHTML = "<p>Waiting for Plex titles...</p>";
      return;
    }
    container.innerHTML = "<p>Loading random movies...</p>";
    try {
      const randomTerms = ['action', 'comedy', 'drama', 'thriller', 'romance'];
      const term = randomTerms[Math.floor(Math.random() * randomTerms.length)];
      const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(term)}`);
      const data = await res.json();
      container.innerHTML = "";
      if (data.results && data.results.length) {
        for (const movie of data.results.slice(0, 6)) {
          const alreadyOnPlex = isOnPlex(movie.title);

          const imdbRating = movie.vote_average ? movie.vote_average.toFixed(1) : "N/A";
          const rtRating = "N/A";

          const div = document.createElement("div");
          div.className = "movie";
          div.innerHTML = `
            <img src="${getPosterUrl(movie.poster_path)}" />
            <div>
              <h3>${highlightMatch(movie.title)} (${getYear(movie.release_date)})</h3>
              <div class="ratings">
                <span class="score"><img src="${IMDB_ICON}" alt="IMDb" title="TMDb Average" />${imdbRating}</span>
                <span class="score"><img src="${RT_ICON}" alt="Rotten Tomatoes" title="Rotten Tomatoes" />${rtRating}</span>
              </div>
              <p>Movie</p>
              <button ${alreadyOnPlex ? "class='danflix-button' disabled" : `onclick='requestMovie(${JSON.stringify({
                Title: movie.title,
                Year: getYear(movie.release_date),
                imdbID: "",
                Plot: movie.overview,
                Poster: getPosterUrl(movie.poster_path)
              })})'`}>
                ${alreadyOnPlex ? "On DanFlix" : "Request"}
              </button>
            </div>`;
          container.appendChild(div);
        }
      } else {
        container.innerHTML = "<p>No random movies found.</p>";
      }
    } catch (err) {
      container.innerHTML = "<p>Error loading movies.</p>";
    }
  }

  // Search movies via TMDb
  async function searchMovies() {
    const query = document.getElementById("searchInput").value.trim();
    const resultsContainer = document.getElementById("results");
    const randomMovies = document.getElementById("randomMovies");

    if (!plexReady) {
      resultsContainer.innerHTML = "<p>Waiting for Plex titles...</p>";
      return;
    }

    if (!query) {
      randomMovies.style.display = 'block';
      resultsContainer.innerHTML = '';
      fetchRandomMovies();
      return;
    }
    randomMovies.style.display = 'none';
    resultsContainer.innerHTML = "<p>Searching...</p>";
    try {
      const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
      const data = await res.json();
      resultsContainer.innerHTML = "";

      const searchTerm = query.trim().toLowerCase();
      let displayMovies = (data.results || []).filter(movie => movie.title);

      function getMatchType(title, term) {
        const normTitle = title.trim().toLowerCase();
        if (normTitle === term) return 2; // Exact match
        if (normTitle.includes(term)) return 1;
        return 0;
      }
      displayMovies.sort((a, b) => {
        const aType = getMatchType(a.title, searchTerm);
        const bType = getMatchType(b.title, searchTerm);
        return bType - aType;
      });

      if (displayMovies.length === 0) {
        resultsContainer.innerHTML = "<p>No results found.</p>";
        return;
      }

      for (const movie of displayMovies) {
        const alreadyOnPlex = isOnPlex(movie.title);

        const imdbRating = movie.vote_average ? movie.vote_average.toFixed(1) : "N/A";
        const rtRating = "N/A";

        const div = document.createElement("div");
        div.className = "movie";
        div.innerHTML = `
          <img src="${getPosterUrl(movie.poster_path)}" />
          <div>
            <h3>${highlightMatch(movie.title)} (${getYear(movie.release_date)})</h3>
            <div class="ratings">
              <span class="score"><img src="${IMDB_ICON}" alt="IMDb" title="TMDb Average" />${imdbRating}</span>
              <span class="score"><img src="${RT_ICON}" alt="Rotten Tomatoes" title="Rotten Tomatoes" />${rtRating}</span>
            </div>
            <p>${movie.overview || "No description available."}</p>
            <button ${alreadyOnPlex ? "class='danflix-button' disabled" : `onclick='requestMovie(${JSON.stringify({
              Title: movie.title,
              Year: getYear(movie.release_date),
              imdbID: "",
              Plot: movie.overview,
              Poster: getPosterUrl(movie.poster_path)
            })})'`}>
              ${alreadyOnPlex ? "On DanFlix" : "Request"}
            </button>
          </div>`;
        resultsContainer.appendChild(div);
      }
    } catch (err) {
      resultsContainer.innerHTML = "<p>Search error.</p>";
    }
  }

  async function requestMovie(movie) {
    const user = await getCurrentUser();
    if (!user) {
      alert("Please log in to request a movie.");
      showAuthOverlay();
      return;
    }
    if (!plexReady) {
      alert("Please wait for Plex titles to load before requesting.");
      return;
    }
    if (isOnPlex(movie.Title)) {
      alert(`"${movie.Title}" is already on Danflix!`);
      return;
    }
    const res = await fetch(`${SUPABASE_URL}/rest/v1/requests`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Prefer": "return=representation"
      },
      body: JSON.stringify([{
        title: movie.Title,
        year: movie.Year,
        imdbID: movie.imdbID || "",
        description: movie.Plot || "No description provided",
        poster: movie.Poster,
        user_id: user.id,
        user_email: user.email
      }])
    });
    const text = await res.text();
    if (res.ok) {
      alert(`Danflix Thanks you, Allow 24-48 hours for "${movie.Title}"`);
    } else {
      alert("Error submitting request: " + text);
    }
  }

  window.onload = async function() {
    const { data } = await supabase.auth.getUser();
    if (data?.user) {
      showUser(data.user);
      hideAuthOverlay();
    } else {
      showAuthOverlay();
    }
    await fetchPlexTitles();
    fetchRandomMovies();
  };
</script>
</body>
</html>
